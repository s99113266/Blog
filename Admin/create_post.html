<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新增文章</title>
  <link rel="stylesheet" href="css/admin.css">
  <link rel="stylesheet" href="css/admin-nav.css">
  <link rel="stylesheet" href="css/create_post.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <script src="js/admin-nav.js"></script>
  <script src="https://cdn.tiny.cloud/1/5xhu87jrih636d4ok046n6mu76o7roitljb9v5zdwcxqm2re/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
  <nav id="admin-navbar" class="admin-navbar"></nav>
  <div class="admin-container">
    <div class="editor-card">
      <h1 class="editor-title"><i class="fas fa-pencil-alt"></i> 文章編輯器</h1>
      <form id="postForm" class="editor-form">
        <input type="hidden" name="page" value="新增" id="page">
        <!-- 文章編號隱藏欄位，僅在編輯模式下添加 -->
        
        <div class="form-group floating-label">
          <input type="text" id="title" name="title" class="form-control" required placeholder=" ">
          <label for="title">文章標題</label>
          <div class="underline"></div>
        </div>

        <div class="form-group editor-content-group">
          <label class="editor-label">文章內容</label>
          <div class="editor-toolbar-border">
            <textarea id="content" name="content" class="rich-editor" required></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group category-select">
            <label for="category">分類選擇</label>
            <div class="custom-select">
              <select id="category" name="category" required>
                <option value="">請選擇分類</option>
              </select>
              <span class="custom-arrow"></span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="pwd">管理員密碼</label>
            <input type="password" id="pwd" name="pwd" class="form-control" required>
          </div>
        </div>
        
        <div class="submit-btn-container">
          <button type="submit" class="submit-btn">
            <span class="btn-icon"><i class="fas fa-paper-plane"></i></span>
            <span class="btn-text">立即發布</span>
          </button>
        </div>
      </form>
      
      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>
  <footer id="footer"></footer>

  <script src="js/admin.js"></script>
  <script>
    // 在 DOMContentLoaded 事件中處理表單提交
    document.addEventListener('DOMContentLoaded', function() {
      // 獲取表單元素
      const postForm = document.getElementById('postForm');
      
      // 移除所有現有的提交事件監聽器
      const oldPostForm = postForm.cloneNode(true);
      postForm.parentNode.replaceChild(oldPostForm, postForm);
      
      // 添加新的提交事件監聽器
      oldPostForm.addEventListener('submit', async function(e) {
        e.preventDefault(); // 阻止表單默認提交
        
        // 獲取 TinyMCE 編輯器內容
        if (tinymce.get('content')) {
          tinymce.get('content').save(); // 確保內容同步到 textarea
        }
        
        // 處理內容中的換行符和雙引號
        const contentTextarea = document.getElementById('content');
        if (contentTextarea && contentTextarea.value) {
          // 將換行符替換為 HTML 換行標籤
          contentTextarea.value = contentTextarea.value.replace(/\n/g, '<br>');
          
          // 將雙引號替換為轉義的雙引號
          contentTextarea.value = contentTextarea.value.replace(/"/g, '\\"');
          
          // 檢查內容是否為空
          if (!contentTextarea.value.trim()) {
            alert('請填寫文章內容');
            return;
          }
          
          // 暫時移除 required 屬性以避免驗證錯誤
          contentTextarea.removeAttribute('required');
        }
        
        // 使用 FormData 獲取表單數據
        const formData = new FormData(this);
        
        const statusMessage = document.getElementById('statusMessage');
        
        try {
          // 獲取 webhook URL
          const webhookConfig = await fetch('../../webhook_config.json')
            .then(response => response.json());
          
          // 發送表單數據
          const response = await fetch(webhookConfig.webhookUrl, {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            // 解析 JSON 回應
            const result = await response.json();
            
            if (result.state === 0) {
              statusMessage.textContent = '文章提交成功！';
              statusMessage.className = 'status-message success';
              
              // 如果是新增文章，則重置表單
              if (document.getElementById('page').value === '新增') {
                this.reset();
                if (tinymce.get('content')) {
                  tinymce.get('content').setContent('');
                }
              }
            } else {
              throw new Error('儲存失敗，請檢查資料是否正確');
            }
          } else {
            throw new Error('伺服器回應錯誤');
          }
        } catch (error) {
          statusMessage.textContent = `提交失敗：${error.message}`;
          statusMessage.className = 'status-message error';
        }
        
        statusMessage.style.display = 'block';
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 5000);
      });
    });
    // 解析 URL 參數的函數
    function getUrlParams() {
      const params = {};
      const queryString = window.location.search.substring(1);
      const pairs = queryString.split('&');
      
      for (const pair of pairs) {
        if (pair === '') continue;
        const parts = pair.split('=');
        params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
      }
      
      return params;
    }

    // 頁面加載時檢查 URL 參數
    document.addEventListener('DOMContentLoaded', function() {
      const params = getUrlParams();
      const pageInput = document.getElementById('page');
      
      // 如果有 no 參數，表示編輯文章
      if (params.no) {
        // 更改 page 值為 "儲存"
        pageInput.value = "儲存";
        
        // 使用 AJAX 獲取文章資料
        fetch(`../../webhook_config.json`)
          .then(response => response.json())
          .then(webhookConfig => {
            // 創建 FormData 對象
            const formData = new FormData();
            formData.append('page', '取得文章');
            formData.append('no', params.no);
            
            // 發送請求獲取文章資料
            return fetch(webhookConfig.webhookUrl, {
              method: 'POST',
              body: formData
            });
          })
          .then(response => response.json())
          .then(data => {
            // 填充表單資料
            document.getElementById('title').value = data.title || '';
            
            // 處理文章內容，將轉義字符轉換回來
            let content = data.content || '';
            
            // 將轉義的雙引號轉換回普通雙引號
            content = content.replace(/\\"/g, '"');
            
            // 將 HTML 換行標籤轉換回換行符
            content = content.replace(/<br\s*\/?>/gi, '\n');
            
            // 等待 TinyMCE 編輯器初始化完成後設置內容
            const setContent = () => {
              if (tinymce.get('content')) {
                tinymce.get('content').setContent(content);
              } else {
                // 如果編輯器尚未初始化，等待 100ms 後再試
                setTimeout(setContent, 100);
              }
            };
            setContent();
            
            // 設置分類（從 class 字段獲取）
            const categorySelect = document.getElementById('category');
            if (data.class) {
              // 遍歷所有選項，找到匹配的選項並設置為選中
              for (let i = 0; i < categorySelect.options.length; i++) {
                if (categorySelect.options[i].value === data.class) {
                  categorySelect.selectedIndex = i;
                  break;
                }
              }
            }
            
            // 顯示發文日期（如果有）
            if (data.date) {
              // 可以在頁面上顯示發文日期，例如添加到標題下方
              const dateInfo = document.createElement('div');
              dateInfo.className = 'date-info';
              dateInfo.textContent = `發布日期：${data.date}`;
              document.querySelector('.editor-title').after(dateInfo);
            }
            
            // 添加文章編號隱藏欄位
            if (data.id) {
              // 檢查是否已存在 no 欄位，如果存在則更新值，否則創建新欄位
              let noInput = document.getElementById('no');
              if (!noInput) {
                noInput = document.createElement('input');
                noInput.type = 'hidden';
                noInput.id = 'no';
                noInput.name = 'no';
                document.getElementById('postForm').appendChild(noInput);
              }
              noInput.value = data.id;
            }
            
            // 添加資料庫主鍵隱藏欄位
            if (data.kp) {
              // 檢查是否已存在 kp 欄位，如果存在則更新值，否則創建新欄位
              let kpInput = document.getElementById('kp');
              if (!kpInput) {
                kpInput = document.createElement('input');
                kpInput.type = 'hidden';
                kpInput.id = 'kp';
                kpInput.name = 'kp';
                document.getElementById('postForm').appendChild(kpInput);
              }
              kpInput.value = data.kp;
            }
            
            // 更新頁面標題
            document.title = '編輯文章';
            document.querySelector('.editor-title').innerHTML = '<i class="fas fa-edit"></i> 文章編輯';
          })
          .catch(error => {
            console.error('獲取文章資料失敗:', error);
            alert('獲取文章資料失敗，請稍後再試');
          });
      } else {
        // 如果沒有 no 參數，表示新增文章
        pageInput.value = "新增";
      }
    });

    tinymce.init({
      selector: '#content',
      plugins: 'image code',
      toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | image code',
      images_upload_handler: function (blobInfo, progress) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject('圖片上傳失敗: ' + error);
          reader.readAsDataURL(blobInfo.blob());
        });
      },
      setup: function(editor) {
        editor.on('init', function() {
          // 編輯器初始化完成後，移除 textarea 的 required 屬性
          document.getElementById('content').removeAttribute('required');
        });
      }
    });
  </script>
</body>
</html>